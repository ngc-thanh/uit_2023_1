-- TAO CSDL QLBH --
CREATE DATABASE QLBH;
USE QLBH;

-- KHACHHANG --
CREATE TABLE KHACHHANG
(
	MAKH char(4) PRIMARY KEY,
	HOTEN varchar(40),
	DCHI varchar(50),
	SODT varchar(20),
	NGSINH smalldatetime,
	DOANHSO money,
	NGDK smalldatetime
);

-- NHANVIEN --
CREATE TABLE NHANVIEN
(
	MANV char(4) PRIMARY KEY,
	HOTEN varchar(40),
	SODT varchar(20),
	NGVL smalldatetime
);

-- SANPHAM --
CREATE TABLE SANPHAM
(
	MASP char(4) PRIMARY KEY,
	TENSP varchar(40),
	DVT varchar(20),
	NUOCSX varchar(40),
	GIA money
);

-- HOADON --
CREATE TABLE HOADON
(
	SOHD int PRIMARY KEY,
	NGHD smalldatetime,
	MAKH char(4) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
	MANV char(4) FOREIGN KEY REFERENCES NHANVIEN(MANV),
	TRIGIA money
);

-- CTHD --
CREATE TABLE CTHD
(
	SOHD int FOREIGN KEY REFERENCES HOADON(SOHD),
	MASP char(4) FOREIGN KEY REFERENCES SANPHAM(MASP),
	SL int,
	PRIMARY KEY(SOHD,MASP)
);

-- PHAN 1 --
-- 1 --

-- 2 --
ALTER TABLE SANPHAM
ADD GHICHU VARCHAR(20);

-- 3 --
ALTER TABLE KHACHHANG
ADD LOAIKH TINYINT;

-- 4 --
ALTER TABLE SANPHAM
ALTER COLUMN GHICHU VARCHAR(100);

-- 5 --
ALTER TABLE SANPHAM
DROP COLUMN GHICHU;

-- 6 --
ALTER TABLE KHACHHANG
ADD LOAIKH VARCHAR(20) CHECK (LOAIKH IN ('Vang lai', 'Thuong xuyen', 'Vip'));

-- 7 --
ALTER TABLE SANPHAM
ADD CONSTRAINT CK_DonViTinh CHECK (DVT IN ('cay', 'hop', 'cai', 'quyen', 'chuc'));

-- 8 --
ALTER TABLE SANPHAM
ADD CONSTRAINT CK_GiaBan CHECK (GIA >= 500);

-- 9 --
ALTER TABLE HOADON
ADD CONSTRAINT CK_SoLuong CHECK (SL > 0);

-- 10 --
ALTER TABLE KHACHHANG
ADD CONSTRAINT CK_NgayDangKy CHECK (NGDK > NGSINH);


-- 11 --
ALTER TABLE HOADON
ADD CONSTRAINT CK_NgayMuaHang CHECK (NGHD >= (SELECT NGDK FROM KHACHHANG WHERE MAKH = HOADON.MAKH));

-- 12 --
ALTER TABLE HOADON
ADD CONSTRAINT CK_NgayBanHang CHECK (NGHD >= (SELECT NGVL FROM NHANVIEN WHERE MANV = HOADON.MANV));


-- 13 --
ALTER TABLE CTHD
ADD CONSTRAINT FK_HOADON_CTHD FOREIGN KEY (SOHD) REFERENCES HOADON (SOHD);


-- 14 --
CREATE TRIGGER TRG_TinhTrigiaHoaDon
AFTER INSERT, UPDATE ON CTHD
FOR EACH ROW
BEGIN
  UPDATE HOADON
  SET TRIGIA = (SELECT SUM(SL * GIA) FROM CTHD WHERE CTHD.SOHD = HOADON.SOHD)
  WHERE SOHD = NEW.SOHD;
END;


-- 15 --
CREATE TRIGGER TRG_TinhDoanhSoKhachHang
AFTER INSERT, UPDATE ON HOADON
FOR EACH ROW
BEGIN
  UPDATE KHACHHANG
  SET DOANHSO = (SELECT SUM(TRIGIA) FROM HOADON WHERE HOADON.MAKH = KHACHHANG.MAKH)
  WHERE MAKH = NEW.MAKH;
END;


-- PHAN 2 --

-- 1. Insert du lieu --
-- INSERT KHACHHANG --
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH01','Nguyen Van A','731 Tran Hung Dao, Q5, TpHCM','8823451','1960-10-22','13,060,000','2006-07-22');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH02','Tran Ngoc Han','23/5 Nguyen Trai, Q5, TpHCM','908256478','1974-04-03','280','2006-07-30');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH03','Tran Ngoc Linh','45 Nguyen Canh Chan, Q1, TpHCM','938776266','1980-06-12','3,860,000','2006-08-05');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH04','Tran Minh Long','50/34 Le Dai Hanh, Q10, TpHCM','917325476','1965-03-09','250','2006-10-02');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH05','Le Nhat Minh','34 Truong Dinh, Q3, TpHCM','8246108','1950-03-10','21','2006-10-28');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH06','Le Hoai Thuong','227 Nguyen Van Cu, Q5, TpHCM','8631738','1981-12-31','915','2006-11-24');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH07','Nguyen Van Tam','32/3 Tran Binh Trong, Q5, TpHCM','916783565','1971-04-06','12,5','2006-12-01');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH08','Phan Thi Thanh','45/2 An Duong Vuong, Q5, TpHCM','938435756','1971-01-10','365','2006-12-13');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH09','Le Ha Vinh','873 Le Hong Phong, Q5, TpHCM','8654763','1979-09-03','70','2007-01-14');
INSERT INTO KHACHHANG (MAKH,HOTEN,DCHI,SODT,NGSINH,DOANHSO,NGDK) VALUES('KH10','Ha Duy Lap','34/34B Nguyen Trai, Q1, TpHCM','8768904','1983-05-02','67,5','2007-01-16');

-- INSERT NHANVIEN --
INSERT INTO NHANVIEN (MANV,HOTEN,SODT,NGVL) VALUES('NV01','Nguyen Nhu Nhut','927345678','2006-04-13');
INSERT INTO NHANVIEN (MANV,HOTEN,SODT,NGVL) VALUES('NV02','Le Thi Phi Yen','987567390','2006-04-21');
INSERT INTO NHANVIEN (MANV,HOTEN,SODT,NGVL) VALUES('NV03','Nguyen Van B','997047382','2006-04-27');
INSERT INTO NHANVIEN (MANV,HOTEN,SODT,NGVL) VALUES('NV04','Ngo Thanh Tuan','913758498','2006-06-24');
INSERT INTO NHANVIEN (MANV,HOTEN,SODT,NGVL) VALUES('NV05','Nguyen Thi Truc Thanh','918590387','2006-07-20');

-- INSERT SANPHAM --
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('BC01','But chi','cay','Singapore','3');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('BC02','But chi','cay','Singapore','5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('BC03','But chi','cay','Viet Nam','3,5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('BC04','But chi','hop','Viet Nam','30');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('BB01','But bi','cay','Viet Nam','5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('BB02','But bi','cay','Trung Quoc','7');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('BB03','But bi','hop','Thai Lan','100');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('TV01','Tap 100 giay mong','quyen','Trung Quoc','2,5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('TV02','Tap 200 giay mong','quyen','Trung Quoc','4,5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('TV03','Tap 100 giay tot','quyen','Viet Nam','3');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('TV04','Tap 200 giay tot','quyen','Viet Nam','5,5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('TV05','Tap 100 trang','chuc','Viet Nam','23');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('TV06','Tap 200 trang','chuc','Viet Nam','53');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('TV07','Tap 100 trang','chuc','Trung Quoc','34');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST01','So tay 500 trang','quyen','Trung Quoc','40');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST02','So tay loai 1','quyen','Viet Nam','55');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST03','So tay loai 2','quyen','Viet Nam','51');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST04','So tay','quyen','Thai Lan','55');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST05','So tay mong','quyen','Thai Lan','20');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST06','Phan viet bang','hop','Viet Nam','5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST07','Phan khong bui','hop','Viet Nam','7');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST08','Bong bang','cai','Viet Nam','1');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST09','But long','cay','Viet Nam','5');
INSERT INTO SANPHAM (MASP,TENSP,DVT,NUOCSX,GIA) VALUES('ST10','But long','cay','Trung Quoc','7');

-- INSERT HOADON --
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1001','2006-07-23','KH01','NV01','320');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1002','2006-08-12','KH01','NV02','840');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1003','2006-08-23','KH02','NV01','100');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1004','2006-09-01','KH02','NV01','180');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1005','2006-10-20','KH01','NV02','3,800,000');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1006','2006-10-16','KH01','NV03','2,430,000');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1007','2006-10-28','KH03','NV03','510');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1008','2006-10-28','KH01','NV03','440');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1009','2006-10-28','KH03','NV04','200');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1010','2006-11-01','KH01','NV01','5,200,000');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1011','2006-11-04','KH04','NV03','250');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1012','2006-11-30','KH05','NV03','21');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1013','2006-12-12','KH06','NV01','5');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1014','2006-12-31','KH03','NV02','3,150,000');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1015','2007-01-01','KH06','NV01','910');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1016','2007-01-01','KH07','NV02','12,5');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1017','2007-01-02','KH08','NV03','35');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1018','2007-01-13','KH08','NV03','330');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1019','2007-01-13','KH01','NV03','30');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1020','2007-01-14','KH09','NV04','70');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1021','2007-01-16','KH10','NV03','67,5');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1022','2007-01-16',NULL,'NV03','7');
INSERT INTO HOADON (SOHD,NGHD,MAKH,MANV,TRIGIA) VALUES('1023','2007-01-17',NULL,'NV01','330');

-- INSERT CTHD --
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1001','TV02','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1001','ST01','5');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1001','BC01','5');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1001','BC02','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1001','ST08','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1002','BC04','20');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1002','BB01','20');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1002','BB02','20');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1003','BB03','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1004','TV01','20');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1004','TV02','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1004','TV03','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1004','TV04','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1005','TV05','50');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1005','TV06','50');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1006','TV07','20');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1006','ST01','30');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1006','ST02','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1007','ST03','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1008','ST04','8');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1009','ST05','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1010','TV07','50');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1010','ST07','50');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1010','ST08','100');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1010','ST04','50');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1010','TV03','100');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1011','ST06','50');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1012','ST07','3');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1013','ST08','5');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1014','BC02','80');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1014','BB02','100');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1014','BC04','60');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1014','BB01','50');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1015','BB02','30');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1015','BB03','7');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1016','TV01','5');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1017','TV02','1');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1017','TV03','1');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1017','TV04','5');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1018','ST04','6');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1019','ST05','1');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1019','ST06','2');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1020','ST07','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1021','ST08','5');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1021','TV01','7');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1021','TV02','10');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1022','ST07','1');
INSERT INTO CTHD (SOHD,MASP,SL) VALUES('1023','ST04','6');


-- 2.	Tạo quan hệ SANPHAM1 chứa toàn bộ dữ liệu của quan hệ SANPHAM. Tạo quan hệ KHACHHANG1 chứa toàn bộ dữ liệu của quan hệ KHACHHANG. --
INSERT INTO SANPHAM1 SELECT * FROM SANPHAM;
INSERT INTO KHACHHANG1 SELECT * FROM KHACHHANG;

-- 3.	Cập nhật giá tăng 5% đối với những sản phẩm do “Thai Lan” sản xuất (cho quan hệ SANPHAM1) --
UPDATE SANPHAM1
SET GIA = GIA * 1.05
WHERE NUOCSX = 'Thai Lan';

-- 4.	Cập nhật giá giảm 5% đối với những sản phẩm do “Trung Quoc” sản xuất có giá từ 10.000 trở xuống (cho quan hệ SANPHAM1).
UPDATE SANPHAM1 
SET GIA = GIA * 0.95
WHERE NUOCSX = 'Trung Quoc' AND GIA >= 10000;

-- 5.	Cập nhật giá trị LOAIKH là “Vip” đối với những khách hàng đăng ký thành viên trước ngày 1/1/2007 có doanh số từ 10.000.000 trở lên hoặc khách hàng đăng ký thành viên từ 1/1/2007 trở về sau có doanh số từ 2.000.000 trở lên (cho quan hệ KHACHHANG1).
UPDATE KHACHHANG1
SET LOAIKH = 'Vip'
WHERE (NGDK < '2007-01-01' AND DOANHSO >= 10000000)
   OR (NGDK >= '2007-01-01' AND DOANHSO >= 2000000);

-- PHAN 3 --
-- 1.	In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất. --
SELECT MASP, TENSP
FROM SANPHAM1
WHERE NUOCSX = 'Trung Quoc';

-- 2.	In ra danh sách các sản phẩm (MASP, TENSP) có đơn vị tính là “cay”, ”quyen”. --
SELECT MASP, TENSP
FROM SANPHAM1
WHERE DONVITINH IN ('cay', 'quyen');

-- 3.	In ra danh sách các sản phẩm (MASP,TENSP) có mã sản phẩm bắt đầu là “B” và kết thúc là “01”. --
SELECT MASP, TENSP
FROM SANPHAM1
WHERE MASP LIKE 'B%01';

-- 4.	In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quốc” sản xuất có giá từ 30.000 đến 40.000. --
SELECT MASP, TENSP
FROM SANPHAM1
WHERE NUOCSX = 'Trung Quoc' AND GiaBan BETWEEN 30000 AND 40000;

-- 5.	In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” hoặc “Thai Lan” sản xuất có giá từ 30.000 đến 40.000. --
SELECT MASP, TENSP
FROM SANPHAM1
WHERE (NUOCSX = 'Trung Quoc' OR NUOCSX = 'Thai Lan') AND GiaBan BETWEEN 30000 AND 40000;

-- 6.	In ra các số hóa đơn, trị giá hóa đơn bán ra trong ngày 1/1/2007 và ngày 2/1/2007. --
SELECT SOHD, TONGTIEN
FROM HOADON
WHERE NGAYBAN BETWEEN '2007-01-01' AND '2007-01-02';

-- 7.	In ra các số hóa đơn, trị giá hóa đơn trong tháng 1/2007, sắp xếp theo ngày (tăng dần) và trị giá của hóa đơn (giảm dần). --
SELECT SOHD, TONGTIEN
FROM HOADON
WHERE NGAYBAN BETWEEN '2007-01-01' AND '2007-01-31'
ORDER BY NGAYBAN ASC, TONGTIEN DESC;

-- 8.	In ra danh sách các khách hàng (MAKH, HOTEN) đã mua hàng trong ngày 1/1/2007. -- 
SELECT DISTINCT KHACHHANG1.MAKH, KHACHHANG1.HOTEN
FROM KHACHHANG1
JOIN HOADON ON KHACHHANG1.MAKH = HOADON.MAKH
WHERE HOADON.NGAYBAN = '2007-01-01';

-- 9.	In ra số hóa đơn, trị giá các hóa đơn do nhân viên có tên “Nguyen Van B” lập trong ngày 28/10/2006. -- 
SELECT SOHD, TONGTIEN
FROM HOADON
WHERE NGAYLAP = '2006-10-28' AND MANV IN (
    SELECT MANV
    FROM NHANVIEN
    WHERE HOTEN = 'Nguyen Van B'
);

-- 10.	In ra danh sách các sản phẩm (MASP,TENSP) được khách hàng có tên “Nguyen Van A” mua trong tháng 10/2006. -- 
SELECT DISTINCT SANPHAM1.MASP, SANPHAM1.TENSP
FROM SANPHAM1
JOIN CTHD ON SANPHAM1.MASP = CTHD.MASP
JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
JOIN KHACHHANG1 ON HOADON.MAKH = KHACHHANG1.MAKH
WHERE KHACHHANG1.HOTEN = 'Nguyen Van A' AND HOADON.NGAYBAN BETWEEN '2006-10-01' AND '2006-10-31';

-- 11.	Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”. -- 
SELECT DISTINCT HOADON.SOHD
FROM HOADON
JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
WHERE CTHD.MASP IN ('BB01', 'BB02');

-- 12.	Tìm các số hóa đơn đã mua sản phẩm có mã số “BB01” hoặc “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20. -- 
SELECT HOADON.SOHD
FROM HOADON
JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
WHERE CTHD.MASP IN ('BB01', 'BB02')
  AND CTHD.SL BETWEEN 10 AND 20;

-- 13.	Tìm các số hóa đơn mua cùng lúc 2 sản phẩm có mã số “BB01” và “BB02”, mỗi sản phẩm mua với số lượng từ 10 đến 20. --
SELECT HOADON.SOHD
FROM HOADON
JOIN CTHD CTHD1 ON HOADON.SOHD = CTHD1.SOHD
JOIN CTHD CTHD2 ON HOADON.SOHD = CTHD2.SOHD
WHERE CTHD1.MASP = 'BB01' AND CTHD1.SL BETWEEN 10 AND 20
  AND CTHD2.MASP = 'BB02' AND CTHD2.SL BETWEEN 10 AND 20;

-- 14.	In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất hoặc các sản phẩm được bán ra trong ngày 1/1/2007. -- 
SELECT MASP, TENSP
FROM SANPHAM1
WHERE NUOCSX = 'Trung Quoc'
   OR MASP IN (SELECT DISTINCT MASP FROM CTHD JOIN HOADON ON CTHD.SOHD = HOADON.SOHD WHERE NGAYBAN = '2007-01-01');

-- 15.	In ra danh sách các sản phẩm (MASP,TENSP) không bán được. -- 
SELECT MASP, TENSP
FROM SANPHAM1
WHERE MASP NOT IN (SELECT DISTINCT MASP FROM CTHD);

-- 16.	In ra danh sách các sản phẩm (MASP,TENSP) không bán được trong năm 2006.
SELECT MASP, TENSP
FROM SANPHAM1
WHERE MASP NOT IN (SELECT DISTINCT MASP FROM CTHD JOIN HOADON ON CTHD.SOHD = HOADON.SOHD WHERE YEAR(NGAYBAN) = 2006);

-- 17.	In ra danh sách các sản phẩm (MASP,TENSP) do “Trung Quoc” sản xuất không bán được trong năm 2006.
SELECT MASP, TENSP
FROM SANPHAM1
WHERE NUOCSX = 'Trung Quoc' AND MASP NOT IN (SELECT DISTINCT MASP FROM CTHD JOIN HOADON ON CTHD.SOHD = HOADON.SOHD WHERE YEAR(NGAYBAN) = 2006);

-- 18.	Tìm số hóa đơn đã mua tất cả các sản phẩm do Singapore sản xuất.
SELECT HOADON.SOHD
FROM HOADON
JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
WHERE CTHD.MASP NOT IN (SELECT DISTINCT MASP FROM SANPHAM1 WHERE NUOCSX <> 'Singapore');

-- 19.	Tìm số hóa đơn trong năm 2006 đã mua ít nhất tất cả các sản phẩm do Singapore sản xuất.
SELECT HOADON.SOHD
FROM HOADON
JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
WHERE YEAR(NGAYBAN) = 2006
GROUP BY HOADON.SOHD
HAVING COUNT(DISTINCT CTHD.MASP) = (SELECT COUNT(DISTINCT MASP) FROM SANPHAM1 WHERE NUOCSX = 'Singapore');

-- 20.	Có bao nhiêu hóa đơn không phải của khách hàng đăng ký thành viên mua?
SELECT COUNT(DISTINCT SOHD)
FROM HOADON
WHERE MAKH NOT IN (SELECT MAKH FROM KHACHHANG1 WHERE LOAIKH = 'Dang ky thanh vien');

-- 21.	Có bao nhiêu sản phẩm khác nhau được bán ra trong năm 2006.
SELECT COUNT(DISTINCT MASP)
FROM CTHD
JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE YEAR(NGAYBAN) = 2006;

-- 22.	Cho biết trị giá hóa đơn cao nhất, thấp nhất là bao nhiêu ?
SELECT MAX(TONGTIEN) AS TrigiaCaoNhat, MIN(TONGTIEN) AS TrigiaThapNhat
FROM HOADON;

-- 23.	Trị giá trung bình của tất cả các hóa đơn được bán ra trong năm 2006 là bao nhiêu?
SELECT AVG(TONGTIEN) AS TrigiaTrungBinh
FROM HOADON
WHERE YEAR(NGAYBAN) = 2006;

-- 24.	Tính doanh thu bán hàng trong năm 2006.
SELECT SUM(TONGTIEN) AS DoanhThu
FROM HOADON
WHERE YEAR(NGAYBAN) = 2006;

-- 25.	Tìm số hóa đơn có trị giá cao nhất trong năm 2006.
SELECT SOHD, TONGTIEN
FROM HOADON
WHERE TONGTIEN = (SELECT MAX(TONGTIEN) FROM HOADON WHERE YEAR(NGAYBAN) = 2006);

-- 26.	Tìm họ tên khách hàng đã mua hóa đơn có trị giá cao nhất trong năm 2006.
SELECT KHACHHANG1.HOTEN
FROM KHACHHANG1
JOIN HOADON ON KHACHHANG1.MAKH = HOADON.MAKH
WHERE HOADON.TONGTIEN = (SELECT MAX(TONGTIEN) FROM HOADON WHERE YEAR(NGAYBAN) = 2006);

-- 27.	In ra danh sách 3 khách hàng đầu tiên (MAKH, HOTEN) sắp xếp theo doanh số giảm dần.
SELECT MAKH, HOTEN
FROM KHACHHANG1
ORDER BY (SELECT SUM(TONGTIEN) FROM HOADON WHERE HOADON.MAKH = KHACHHANG1.MAKH) DESC
LIMIT 3;

-- 28.	In ra danh sách các sản phẩm (MASP, TENSP) có giá bán bằng 1 trong 3 mức giá cao nhất.
SELECT MASP, TENSP
FROM SANPHAM1
WHERE GiaBan IN (SELECT DISTINCT GiaBan FROM SANPHAM1 ORDER BY GiaBan DESC LIMIT 3);

-- 29.	In ra danh sách các sản phẩm (MASP, TENSP) do “Thai Lan” sản xuất có giá bằng 1 trong 3 mức giá cao nhất (của tất cả các sản phẩm).
SELECT MASP, TENSP
FROM SANPHAM1
WHERE NUOCSX = 'Thai Lan' AND GiaBan IN (SELECT DISTINCT GiaBan FROM SANPHAM1 WHERE NUOCSX = 'Thai Lan' ORDER BY GiaBan DESC LIMIT 3);

-- 30.	In ra danh sách các sản phẩm (MASP, TENSP) do “Trung Quoc” sản xuất có giá bằng 1 trong 3 mức giá cao nhất (của sản phẩm do “Trung Quoc” sản xuất).
SELECT MASP, TENSP
FROM SANPHAM1
WHERE NUOCSX = 'Trung Quoc' AND GiaBan IN (SELECT DISTINCT GiaBan FROM SANPHAM1 WHERE NUOCSX = 'Trung Quoc' ORDER BY GiaBan DESC LIMIT 3);

-- 31.	* In ra danh sách khách hàng nằm trong 3 hạng cao nhất (xếp hạng theo doanh số).
SELECT KHACHHANG1.MAKH, KHACHHANG1.HOTEN
FROM KHACHHANG1
JOIN HOADON ON KHACHHANG1.MAKH = HOADON.MAKH
GROUP BY KHACHHANG1.MAKH, KHACHHANG1.HOTEN
ORDER BY SUM(HOADON.TONGTIEN) DESC
LIMIT 3;

-- 32.	Tính tổng số sản phẩm do “Trung Quoc” sản xuất.
SELECT COUNT(MASP) AS TongSanPhamTrungQuoc
FROM SANPHAM1
WHERE NUOCSX = 'Trung Quoc';

-- 33.	Tính tổng số sản phẩm của từng nước sản xuất.
SELECT NUOCSX, COUNT(MASP) AS TongSanPham
FROM SANPHAM1
GROUP BY NUOCSX;

-- 34.	Với từng nước sản xuất, tìm giá bán cao nhất, thấp nhất, trung bình của các sản phẩm.
SELECT NUOCSX, MAX(GiaBan) AS GiaBanCaoNhat, MIN(GiaBan) AS GiaBanThapNhat, AVG(GiaBan) AS GiaBanTrungBinh
FROM SANPHAM1
GROUP BY NUOCSX;

-- 35.	Tính doanh thu bán hàng mỗi ngày.
SELECT NGAYBAN, SUM(TONGTIEN) AS DoanhThu
FROM HOADON
GROUP BY NGAYBAN;

-- 36.	Tính tổng số lượng của từng sản phẩm bán ra trong tháng 10/2006.
SELECT CTHD.MASP, SANPHAM1.TENSP, SUM(CTHD.SL) AS TongSoLuong
FROM CTHD
JOIN SANPHAM1 ON CTHD.MASP = SANPHAM1.MASP
JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE YEAR(NGAYBAN) = 2006 AND MONTH(NGAYBAN) = 10
GROUP BY CTHD.MASP, SANPHAM1.TENSP;

-- 37.	Tính doanh thu bán hàng của từng tháng trong năm 2006.
SELECT MONTH(NGAYBAN) AS Thang, SUM(TONGTIEN) AS DoanhThu
FROM HOADON
WHERE YEAR(NGAYBAN) = 2006
GROUP BY MONTH(NGAYBAN);

-- 38.	Tìm hóa đơn có mua ít nhất 4 sản phẩm khác nhau.
SELECT SOHD
FROM CTHD
GROUP BY SOHD
HAVING COUNT(DISTINCT MASP) >= 4;

-- 39.	Tìm hóa đơn có mua 3 sản phẩm do “Viet Nam” sản xuất (3 sản phẩm khác nhau).
SELECT HOADON.SOHD
FROM HOADON
JOIN CTHD ON HOADON.SOHD = CTHD.SOHD
JOIN SANPHAM1 ON CTHD.MASP = SANPHAM1.MASP
WHERE NUOCSX = 'Viet Nam'
GROUP BY HOADON.SOHD
HAVING COUNT(DISTINCT CTHD.MASP) = 3;

-- 40.	Tìm khách hàng (MAKH, HOTEN) có số lần mua hàng nhiều nhất.
SELECT MAKH, HOTEN
FROM KHACHHANG1
WHERE MAKH IN (SELECT MAKH FROM HOADON GROUP BY MAKH ORDER BY COUNT(*) DESC LIMIT 1);

-- 41.	Tháng mấy trong năm 2006, doanh số bán hàng cao nhất ?
SELECT MONTH(NGAYBAN) AS Thang, SUM(TONGTIEN) AS DoanhSo
FROM HOADON
WHERE YEAR(NGAYBAN) = 2006
GROUP BY MONTH(NGAYBAN)
ORDER BY SUM(TONGTIEN) DESC
LIMIT 1;

-- 42.	Tìm sản phẩm (MASP, TENSP) có tổng số lượng bán ra thấp nhất trong năm 2006.
SELECT CTHD.MASP, SANPHAM1.TENSP, SUM(CTHD.SL) AS TongSoLuong
FROM CTHD
JOIN SANPHAM1 ON CTHD.MASP = SANPHAM1.MASP
JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE YEAR(NGAYBAN) = 2006
GROUP BY CTHD.MASP, SANPHAM1.TENSP
ORDER BY TongSoLuong
LIMIT 1;

-- 43.	*Mỗi nước sản xuất, tìm sản phẩm (MASP,TENSP) có giá bán cao nhất.
SELECT NUOCSX, MASP, TENSP, GiaBan
FROM SANPHAM1
WHERE (NUOCSX, GiaBan) IN (SELECT NUOCSX, MAX(GiaBan) FROM SANPHAM1 GROUP BY NUOCSX);

-- 44.	Tìm nước sản xuất sản xuất ít nhất 3 sản phẩm có giá bán khác nhau.
SELECT NUOCSX
FROM SANPHAM1
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GiaBan) >= 3;

-- 45.	*Trong 10 khách hàng có doanh số cao nhất, tìm khách hàng có số lần mua hàng nhiều nhất.
SELECT KHACHHANG1.MAKH, KHACHHANG1.HOTEN, COUNT(HOADON.MAKH) AS SoLanMua
FROM KHACHHANG1
JOIN HOADON ON KHACHHANG1.MAKH = HOADON.MAKH
WHERE KHACHHANG1.MAKH IN (SELECT MAKH FROM HOADON GROUP BY MAKH ORDER BY SUM(TONGTIEN) DESC LIMIT 10)
GROUP BY KHACHHANG1.MAKH, KHACHHANG1.HOTEN
ORDER BY SoLanMua DESC
LIMIT 1;



-- BAI TAP 2 --

-- TAO CSDL QLGV --
CREATE DATABASE QLGV;
USE QLGV;

-- KHOA --
CREATE TABLE KHOA
(
	MAKHOA varchar(4) PRIMARY KEY,
	TENKHOA varchar(40),
	NGTLAP smalldatetime,
	TRGKHOA char(4)
);

-- MONHOC --
CREATE TABLE MONHOC (
	MAMH varchar(10) PRIMARY KEY,
	TENMH varchar(40),
	TCLT tinyint,
	TCTH tinyint,
	MAKHOA varchar(4)
);

-- DIEUKIEN --
CREATE TABLE DIEUKIEN
(
	MAMH varchar(10),
	MAMH_TRUOC varchar(10),
	PRIMARY KEY (MAMH, MAMH_TRUOC)
);

-- GIAOVIEN --
CREATE TABLE GIAOVIEN
(
	MAGV char(4) PRIMARY KEY,
	HOTEN varchar(40),
	HOCVI varchar(10),
	HOCHAM varchar(10),
	GIOITINH varchar(3),
	NGSINH smalldatetime,
	NGVL smalldatetime,
	HESO numeric(4,2),
	MUCLUONG money,
	MAKHOA varchar(4)
);

-- LOP --
CREATE TABLE LOP
(
	MALOP char(3) PRIMARY KEY,
	TENLOP varchar(40),
	TRGLOP char(5),
	SISO tinyint,
	MAGVCN char(4) 
);

-- HOCVIEN --
CREATE TABLE HOCVIEN
(
	MAHV char(5) PRIMARY KEY,
	HO varchar(40),
	TEN varchar(10),
	NGSINH smalldatetime,
	GIOITINH varchar(3),
	NOISINH varchar(40),
	MALOP char(3)
);

-- GIANGDAY --
CREATE TABLE GIANGDAY
(
	MALOP char(3),
	MAMH varchar(10),
	MAGV char(4),
	HOCKY tinyint,
	NAM smallint,
	TUNGAY smalldatetime,
	DENNGAY smalldatetime,
	PRIMARY KEY (MALOP,MAMH)
);

-- KETQUATHI --
CREATE TABLE KETQUATHI
(
	MAHV char(5),
	MAMH varchar(10),
	LANTHI tinyint,
	NGTHI smalldatetime,
	DIEM numeric(4,2),
	KQUA varchar(10),
	PRIMARY KEY (MAHV,MAMH,LANTHI)
);

-- INSERT KHOA --
INSERT INTO KHOA (MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('KHMT','Khoa hoc may tinh','2005-06-07','GV01');
INSERT INTO KHOA (MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('HTTT','He thong thong tin','2005-06-07','GV02');
INSERT INTO KHOA (MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('CNPM','Cong nghe phan mem','2005-06-07','GV04');
INSERT INTO KHOA (MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('MTT','Mang va truyen thong','2005-10-20','GV03');
INSERT INTO KHOA (MAKHOA,TENKHOA,NGTLAP,TRGKHOA) VALUES('KTMT','Ky thuat may tinh','2005-12-20',NULL);

-- INSERT LOP --
INSERT INTO LOP (MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K11','Lop 1 khoa 1','K1108','11','GV07');
INSERT INTO LOP (MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K12','Lop 2 khoa 1','K1205','12','GV09');
INSERT INTO LOP (MALOP,TENLOP,TRGLOP,SISO,MAGVCN) VALUES('K13','Lop 3 khoa 1','K1305','12','GV14');

-- INSERT MONHOC --
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('THDC','Tin hoc dai cuong','4','1','KHMT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CTRR','Cau truc roi rac','5','0','KHMT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CSDL','Co so du lieu','3','1','HTTT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('CTDLGT','Cau truc du lieu va giai thuat','3','1','KHMT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('PTTKTT','Phan tich thiet ke thuat toan','3','0','KHMT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('DHMT','Do hoa may tinh','3','1','KHMT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('KTMT','Kien truc may tinh','3','0','KTMT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('TKCSDL','Thiet ke co so du lieu','3','1','HTTT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('PTTKHTTT','Phan tich thiet ke he thong thong tin','4','1','HTTT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('HDH','He dieu hanh','4','0','KTMT');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('NMCNPM','Nhap mon cong nghe phan mem','3','0','CNPM');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('LTCFW','Lap trinh C for win','3','1','CNPM');
INSERT INTO MONHOC (MAMH,TENMH,TCLT,TCTH,MAKHOA) VALUES('LTHDT','Lap trinh huong doi tuong','3','1','CNPM');

-- INSERT GIANGDAY --
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','THDC','GV07','1','2006','2006-01-02','2006-05-12');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','THDC','GV06','1','2006','2006-01-02','2006-05-12');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','THDC','GV15','1','2006','2006-01-02','2006-05-12');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CTRR','GV02','1','2006','2006-01-09','2006-05-17');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CTRR','GV02','1','2006','2006-01-09','2006-05-17');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CTRR','GV08','1','2006','2006-01-09','2006-05-17');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CSDL','GV05','2','2006','2006-06-01','2006-07-15');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CSDL','GV09','2','2006','2006-06-01','2006-07-15');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CTDLGT','GV15','2','2006','2006-06-01','2006-07-15');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','CSDL','GV05','3','2006','2006-08-01','2006-12-15');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K13','DHMT','GV07','3','2006','2006-08-01','2006-12-15');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','CTDLGT','GV15','3','2006','2006-08-01','2006-12-15');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','CTDLGT','GV15','3','2006','2006-08-01','2006-12-15');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','HDH','GV04','1','2007','2007-01-02','2007-02-18');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K12','HDH','GV04','1','2007','2007-01-02','2007-03-20');
INSERT INTO GIANGDAY (MALOP,MAMH,MAGV,HOCKY,NAM,TUNGAY,DENNGAY) VALUES('K11','DHMT','GV07','1','2007','2007-02-18','2007-03-20');

-- INSERT GIAOVIEN --
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV01','Ho Thanh Son','PTS','GS','Nam','1950-05-02','2004-01-11','5.00','2,250,000','KHMT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV02','Tran Tam Thanh','TS','PGS','Nam','1965-12-17','2004-04-20','4.50','2,025,000','HTTT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV03','Do Nghiem Phung','TS','GS','Nu','1950-08-01','2004-09-23','4.00','1,800,000','CNPM');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV04','Tran Nam Son','TS','PGS','Nam','1961-02-22','2005-01-12','4.50','2,025,000','KTMT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV05','Mai Thanh Danh','ThS','GV','Nam','1958-03-12','2005-01-12','3.00','1,350,000','HTTT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV06','Tran Doan Hung','TS','GV','Nam','1953-03-11','2005-01-12','4.50','2,025,000','KHMT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV07','Nguyen Minh Tien','ThS','GV','Nam','1971-11-23','2005-03-01','4.00','1,800,000','KHMT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV08','Le Thi Tran','KS',NULL,'Nu','1974-03-26','2005-03-01','1.69','760,5','KHMT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV09','Nguyen To Lan','ThS','GV','Nu','1966-12-31','2005-03-01','4.00','1,800,000','HTTT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV10','Le Tran Anh Loan','KS',NULL,'Nu','1972-07-17','2005-03-01','1.86','837','CNPM');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV11','Ho Thanh Tung','CN','GV','Nam','1980-01-12','2005-05-15','2.67','1,201,500','MTT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV12','Tran Van Anh','CN',NULL,'Nu','1981-03-29','2005-05-15','1.69','760,5','CNPM');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV13','Nguyen Linh Dan','CN',NULL,'Nu','1980-05-23','2005-05-15','1.69','760,5','KTMT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV14','Truong Minh Chau','ThS','GV','Nu','1976-11-30','2005-05-15','3.00','1,350,000','MTT');
INSERT INTO GIAOVIEN (MAGV,HOTEN,HOCVI,HOCHAM,GIOITINH,NGSINH,NGVL,HESO,MUCLUONG,MAKHOA) VALUES('GV15','Le Ha Thanh','ThS','GV','Nam','1978-05-04','2005-05-15','3.00','1,350,000','KHMT');

-- INSERT DIEUKIEN --
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('CSDL','CTRR');
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('CSDL','CTDLGT');
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('CTDLGT','THDC');
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('PTTKTT','THDC');
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('PTTKTT','CTDLGT');
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('DHMT','THDC');
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('LTHDT','THDC');
INSERT INTO DIEUKIEN (MAMH,MAMH_TRUOC) VALUES('PTTKHTTT','CSDL');

-- INSERT KETQUATHI --
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1101','CSDL','1','2006-07-20','10.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1101','CTDLGT','1','2006-12-28','9.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1101','THDC','1','2006-05-20','9.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1101','CTRR','1','2006-05-13','9.50','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','CSDL','1','2006-07-20','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','CSDL','2','2006-07-27','4.25','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','CSDL','3','2006-08-10','4.50','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','1','2006-12-28','4.50','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','2','2007-01-05','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','CTDLGT','3','2007-01-15','6.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','THDC','1','2006-05-20','5.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1102','CTRR','1','2006-05-13','7.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1103','CSDL','1','2006-07-20','3.50','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1103','CSDL','2','2006-07-27','8.25','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1103','CTDLGT','1','2006-12-28','7.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1103','THDC','1','2006-05-20','8.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1103','CTRR','1','2006-05-13','6.50','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1104','CSDL','1','2006-07-20','3.75','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1104','CTDLGT','1','2006-12-28','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1104','THDC','1','2006-05-20','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1104','CTRR','1','2006-05-13','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1104','CTRR','2','2006-05-20','3.50','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1104','CTRR','3','2006-06-30','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1201','CSDL','1','2006-07-20','6.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1201','CTDLGT','1','2006-12-28','5.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1201','THDC','1','2006-05-20','8.50','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1201','CTRR','1','2006-05-13','9.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','CSDL','1','2006-07-20','8.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','CTDLGT','1','2006-12-28','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','CTDLGT','2','2007-01-05','5.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','THDC','1','2006-05-20','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','THDC','2','2006-05-27','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','CTRR','1','2006-05-13','3.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','CTRR','2','2006-05-20','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1202','CTRR','3','2006-06-30','6.25','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1203','CSDL','1','2006-07-20','9.25','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1203','CTDLGT','1','2006-12-28','9.50','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1203','THDC','1','2006-05-20','10.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1203','CTRR','1','2006-05-13','10.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1204','CSDL','1','2006-07-20','8.50','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1204','CTDLGT','1','2006-12-28','6.75','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1204','THDC','1','2006-05-20','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1204','CTRR','1','2006-05-13','6.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1301','CSDL','1','2006-12-20','4.25','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1301','CTDLGT','1','2006-07-25','8.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1301','THDC','1','2006-05-20','7.75','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1301','CTRR','1','2006-05-13','8.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1302','CSDL','1','2006-12-20','6.75','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1302','CTDLGT','1','2006-07-25','5.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1302','THDC','1','2006-05-20','8.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1302','CTRR','1','2006-05-13','8.50','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1303','CSDL','1','2006-12-20','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','1','2006-07-25','4.50','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','2','2006-08-07','4.00','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1303','CTDLGT','3','2006-08-15','4.25','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1303','THDC','1','2006-05-20','4.50','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1303','CTRR','1','2006-05-13','3.25','Khong Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1303','CTRR','2','2006-05-20','5.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1304','CSDL','1','2006-12-20','7.75','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1304','CTDLGT','1','2006-07-25','9.75','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1304','THDC','1','2006-05-20','5.50','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1304','CTRR','1','2006-05-13','5.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1305','CSDL','1','2006-12-20','9.25','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1305','CTDLGT','1','2006-07-25','10.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1305','THDC','1','2006-05-20','8.00','Dat');
INSERT INTO KETQUATHI (MAHV,MAMH,LANTHI,NGTHI,DIEM,KQUA) VALUES('K1305','CTRR','1','2006-05-13','10.00','Dat');

-- INSERT HOCVIEN --
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1101','Nguyen Van','A','1986-01-27','Nam','TpHCM','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1102','Tran Ngoc','Han','1986-03-14','Nu','Kien Giang','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1103','Ha Duy','Lap','1986-04-18','Nam','Nghe An','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1104','Tran Ngoc','Linh','1986-03-30','Nu','Tay Ninh','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1105','Tran Minh','Long','1986-02-27','Nam','TpHCM','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1106','Le Nhat','Minh','1986-01-24','Nam','TpHCM','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1107','Nguyen Nhu','Nhut','1986-01-27','Nam','Ha Noi','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1108','Nguyen Manh','Tam','1986-02-27','Nam','Kien Giang','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1109','Phan Thi Thanh','Tam','1986-01-27','Nu','Vinh Long','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1110','Le Hoai','Thuong','1986-02-05','Nu','Can Tho','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1111','Le Ha','Vinh','1986-12-25','Nam','Vinh Long','K11');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1201','Nguyen Van','B','1986-02-11','Nam','TpHCM','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1202','Nguyen Thi Kim','Duyen','1986-01-18','Nu','TpHCM','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1203','Tran Thi Kim','Duyen','1986-09-17','Nu','TpHCM','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1204','Truong My','Hanh','1986-05-19','Nu','Dong Nai','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1205','Nguyen Thanh','Nam','1986-04-17','Nam','TpHCM','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1206','Nguyen Thi Truc','Thanh','1986-03-04','Nu','Kien Giang','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1207','Tran Thi Bich','Thuy','1986-02-08','Nu','Nghe An','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1208','Huynh Thi Kim','Trieu','1986-04-08','Nu','Tay Ninh','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1209','Pham Thanh','Trieu','1986-02-23','Nam','TpHCM','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1210','Ngo Thanh','Tuan','1986-02-14','Nam','TpHCM','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1211','Do Thi','Xuan','1986-03-09','Nu','Ha Noi','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1212','Le Thi Phi','Yen','1986-03-12','Nu','TpHCM','K12');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1301','Nguyen Thi Kim','Cuc','1986-06-09','Nu','Kien Giang','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1302','Truong Thi My','Hien','1986-03-18','Nu','Nghe An','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1303','Le Duc','Hien','1986-03-21','Nam','Tay Ninh','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1304','Le Quang','Hien','1986-04-18','Nam','TpHCM','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1305','Le Thi','Huong','1986-03-27','Nu','TpHCM','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1306','Nguyen Thai','Huu','1986-03-30','Nam','Ha Noi','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1307','Tran Minh','Man','1986-05-28','Nam','TpHCM','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1308','Nguyen Hieu','Nghia','1986-04-08','Nam','Kien Giang','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1309','Nguyen Trung','Nghia','1987-01-18','Nam','Nghe An','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1310','Tran Thi Hong','Tham','1986-04-22','Nu','Tay Ninh','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1311','Tran Minh','Thuc','1986-04-04','Nam','TpHCM','K13');
INSERT INTO HOCVIEN (MAHV,HO,TEN,NGSINH,GIOITINH,NOISINH,MALOP) VALUES('K1312','Nguyen Thi Kim','Yen','1986-09-07','Nu','TpHCM','K13');

-- THIET LAP KHOA NGOAI --
ALTER TABLE MONHOC ADD CONSTRAINT FK_MAKHOA_MONHOC FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA);
ALTER TABLE DIEUKIEN ADD CONSTRAINT FK_MAMH_DIEUKIEN FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH);
ALTER TABLE DIEUKIEN ADD CONSTRAINT FK_MAMH_TRUOC_DIEUKIEN FOREIGN KEY (MAMH_TRUOC) REFERENCES MONHOC(MAMH);
ALTER TABLE KHOA ADD CONSTRAINT FK_TRGKHOA_GIAOVIEN FOREIGN KEY (TRGKHOA)  REFERENCES GIAOVIEN(MAGV);
ALTER TABLE GIANGDAY ADD CONSTRAINT FK_MALOP_GIANGDAY FOREIGN KEY(MALOP) REFERENCES LOP(MALOP);
ALTER TABLE GIANGDAY ADD CONSTRAINT FK_MAMH_GIANGDAY FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH);
ALTER TABLE GIANGDAY ADD CONSTRAINT FK_MAGV_GIANGDAY FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV);
ALTER TABLE KETQUATHI ADD CONSTRAINT FK_MAHV_KETQUATHI FOREIGN KEY(MAHV) REFERENCES HOCVIEN(MAHV);
ALTER TABLE KETQUATHI ADD CONSTRAINT FK_MAMH_KETQUATHI FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH);
ALTER TABLE LOP ADD CONSTRAINT FK_TRGLOP_HOCVIEN FOREIGN KEY (TRGLOP)  REFERENCES HOCVIEN(MAHV);
ALTER TABLE LOP ADD CONSTRAINT FK_MAGVCN_LOP FOREIGN KEY (MAGVCN) REFERENCES GIAOVIEN(MAGV);
ALTER TABLE HOCVIEN ADD CONSTRAINT FK_MALOP_LOP FOREIGN KEY(MALOP) REFERENCES LOP(MALOP);

-- PHAN 1 --
-- 1 --

ALTER TABLE HOCVIEN
ADD GHICHU NVARCHAR(255),
    DIEMTB FLOAT,
    XEPLOAI NVARCHAR(50);

-- 2 --
CREATE TRIGGER TRG_GenerateMaHV
BEFORE INSERT ON HOCVIEN
FOR EACH ROW
BEGIN
  DECLARE @MaLop CHAR(3);
  DECLARE @SoThuTu INT;
  SET @MaLop = (SELECT MALOP FROM LOP WHERE MALOP = NEW.MALOP);
  SET @SoThuTu = (SELECT ISNULL(MAX(CAST(RIGHT(MAHV, 2) AS INT)), 0) + 1 FROM HOCVIEN WHERE MALOP = @MaLop);
  SET NEW.MAHV = @MaLop + RIGHT('00' + CAST(@SoThuTu AS NVARCHAR(2)), 2);
END;

-- 3 --
ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_GioiTinh CHECK (GIOITINH IN ('Nam', 'Nu'));

-- 4 --
ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_DiemThi CHECK (DIEM >= 0 AND DIEM <= 10);

-- 5 --
ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_KetQuaThi CHECK (KQUA IN ('Dat', 'Khong dat'));

-- 6 --
ALTER TABLE KETQUATHI
ADD CONSTRAINT CK_SoLanThi CHECK (LANTHI >= 1 AND LANTHI <= 3);

-- 7 --
ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_HocKy CHECK (HOCKY >= 1 AND HOCKY <= 3);

-- 8 --
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_HocVi CHECK (HOCHAM IN ('CN', 'KS', 'Ths', 'TS', 'PTS'));

-- 9 --
ALTER TABLE LOP
ADD CONSTRAINT FK_LopTruong FOREIGN KEY (LOPTRG) REFERENCES HOCVIEN (MAHV);

-- 10 --
ALTER TABLE KHOA
ADD CONSTRAINT FK_TruongKhoa FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN (MAGV)
  CHECK (GIAOVIEN.HOCHAM IN ('TS', 'PTS'));

-- 11 --
ALTER TABLE HOCVIEN
ADD CONSTRAINT CK_Tuoi CHECK (DATEDIFF(YEAR, NGSINH, GETDATE()) >= 18);

-- 12 --
ALTER TABLE GIANGDAY
ADD CONSTRAINT CK_ThoiGianGiangDay CHECK (TUNGAY < DENNGAY);

-- 13 --
ALTER TABLE GIAOVIEN
ADD CONSTRAINT CK_TuoiGiaoVien CHECK (DATEDIFF(YEAR, NGVL, GETDATE()) >= 22);

-- 14 --
CREATE TRIGGER Trg_CheckTinChiChenhLech
ON MONHOC
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT *
        FROM MONHOC AS mh
        WHERE ABS(mh.TCLT - mh.TCTH) > 3
    )
    BEGIN
        RAISERROR('Số tín chỉ lý thuyết và số tín chỉ thực hành không được chênh lệch quá 3!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;


-- 15 --
CREATE TRIGGER Trg_CheckMonHocDaHocXong
ON KETQUATHI
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT *
        FROM KETQUATHI AS kt
        JOIN LOP AS l ON kt.MALOP = l.MALOP
        WHERE kt.MAMH = l.MAMH_TRUOC AND kt.KQUA = 'Khong dat'
    )
    BEGIN
        RAISERROR('Học viên chỉ được thi môn học nào đã được học xong trong lớp!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;


-- 16 --
CREATE TRIGGER Trg_CheckSoMonHocTrenLop
ON GIANGDAY
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT MALOP, HOCKY, NAM, COUNT(*) AS SoMonHoc
        FROM GIANGDAY
        GROUP BY MALOP, HOCKY, NAM
        HAVING COUNT(*) > 3
    )
    BEGIN
        RAISERROR('Mỗi lớp chỉ được học tối đa 3 môn trong mỗi học kỳ của năm học!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;

-- 17 --
CREATE TRIGGER Trg_CheckSiSoLop
ON HOCVIEN
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT LOP.MALOP
        FROM LOP
        JOIN (SELECT MALOP, COUNT(*) AS SoLuongHocVien
              FROM HOCVIEN
              GROUP BY MALOP) AS SoLuongHocVienTheoLop ON LOP.MALOP = SoLuongHocVienTheoLop.MALOP
        WHERE LOP.SISO <> SoLuongHocVienTheoLop.SoLuongHocVien
    )
    BEGIN
        RAISERROR('Sỉ số của lớp không bằng với số lượng học viên thuộc lớp đó!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;

-- 18 --
CREATE TRIGGER Trg_CheckDIEUKIEN
ON DIEUKIEN
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT *
        FROM DIEUKIEN
        WHERE MAMH = MAMH_TRUOC
    )
    BEGIN
        RAISERROR('Giá trị của thuộc tính MAMH và MAMH_TRUOC không được giống nhau trong cùng một bộ!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END

    IF EXISTS (
        SELECT *
        FROM DIEUKIEN AS D1
        WHERE EXISTS (
            SELECT *
            FROM DIEUKIEN AS D2
            WHERE D1.MAMH = 'A' AND D1.MAMH_TRUOC = 'B' AND D1.MAMH = D2.MAMH_TRUOC AND D1.MAMH_TRUOC = D2.MAMH
        )
    )
    BEGIN
        RAISERROR('Không tồn tại hai bộ ("A", "B") và ("B", "A")!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;


-- 19 --
CREATE TRIGGER Trg_EqualSalary
ON GIAOVIEN
AFTER INSERT, UPDATE
AS
BEGIN
    UPDATE GIAOVIEN
    SET MUCLUONG = (
        SELECT AVG(MUCLUONG)
        FROM GIAOVIEN
        WHERE HOCVI = (SELECT HOCVI FROM INSERTED) AND HOCHAM = (SELECT HOCHAM FROM INSERTED) AND HESO = (SELECT HESO FROM INSERTED)
    )
    WHERE MAGV IN (
        SELECT MAGV
        FROM GIAOVIEN
        WHERE HOCVI = (SELECT HOCVI FROM INSERTED) AND HOCHAM = (SELECT HOCHAM FROM INSERTED) AND HESO = (SELECT HESO FROM INSERTED)
    )
END;

-- 20 --
CREATE TRIGGER Trg_CheckThiLai
ON KETQUATHI
AFTER UPDATE
AS
BEGIN
    -- Kiểm tra học viên chỉ được thi lại khi điểm lần thi trước dưới 5
    IF EXISTS (
        SELECT *
        FROM KETQUATHI AS KQ1
        JOIN KETQUATHI AS KQ2 ON KQ1.MAHV = KQ2.MAHV AND KQ1.MAMH = KQ2.MAMH AND KQ1.LANTHI = KQ2.LANTHI + 1
        WHERE KQ1.DIEM >= 5 AND KQ2.DIEM >= 5
    )
    BEGIN
        RAISERROR('Học viên chỉ được thi lại khi điểm lần thi trước dưới 5!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;

-- 21 --
CREATE TRIGGER Trg_CheckNgayThiSau
ON KETQUATHI
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT *
        FROM KETQUATHI AS kt1
        JOIN KETQUATHI AS kt2 ON kt1.MAHV = kt2.MAHV AND kt1.MAMH = kt2.MAMH
        WHERE kt1.SOLANTHI < kt2.SOLANTHI AND kt1.NGTHI >= kt2.NGTHI
    )
    BEGIN
        RAISERROR('Ngày thi của lần thi sau phải lớn hơn ngày thi của lần thi trước!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;



-- 22 --
CREATE TRIGGER Trg_CheckHocVienThiMonHoc
ON GIANGDAY
AFTER INSERT
AS
BEGIN
    IF EXISTS (
        SELECT *
        FROM HOCVIEN AS HV
        JOIN MONHOC AS MH ON HV.MALOP = (SELECT MALOP FROM INSERTED) AND MH.MAKHOA = HV.MAKHOA
        WHERE MH.MAMH NOT IN (
            SELECT MAMH
            FROM GIANGDAY
            WHERE MALOP = (SELECT MALOP FROM INSERTED)
        )
    )
    BEGIN
        RAISERROR('Học viên chỉ được thi những môn mà lớp đã học xong!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;



-- 23 --
CREATE TRIGGER Trg_CheckPhanCongGiangDay
ON GIANGDAY
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT *
        FROM GIANGDAY AS GD
        JOIN MONHOC AS MH1 ON GD.MAMH = MH1.MAMH
        JOIN MONHOC AS MH2 ON MH1.STT >= MH2.STT
        WHERE GD.MALOP = (SELECT MALOP FROM INSERTED)
        AND MH1.STT <> MH2.STT
    )
    BEGIN
        RAISERROR('Môn học được phân công giảng dạy không tuân theo thứ tự học tập!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;



-- 24 --
CREATE TRIGGER Trg_CheckPhanCongGiangDay
ON GIANGDAY
AFTER INSERT, UPDATE
AS
BEGIN
    IF EXISTS (
        SELECT *
        FROM GIANGDAY AS GD
        JOIN GIAOVIEN AS GV ON GD.MAGV = GV.MAGV
        JOIN MONHOC AS MH ON GD.MAMH = MH.MAMH AND MH.MAKHOA <> GV.MAKHOA
    )
    BEGIN
        RAISERROR('Giáo viên chỉ được phân công dạy những môn thuộc khoa mà giáo viên phụ trách!', 16, 1);
        ROLLBACK TRANSACTION;
        RETURN;
    END
END;


-- PHAN 2 --
-- 1 --
UPDATE GIAOVIEN
SET HESO = HESO + 0.2
WHERE MAGV IN (
    SELECT MAGV
    FROM KHOA K
    INNER JOIN GIAOVIEN G ON K.TRGKHOA = G.MAGV
);

-- 2 --
WITH DiemThiSauCung AS (
    SELECT MAHV, MAMH, MAX(LANTHI) AS LANTHI, DIEM
    FROM KETQUATHI
    GROUP BY MAHV, MAMH
);
UPDATE HOCVIEN
SET DIEMTB = (
    SELECT AVG(DIEM)
    FROM DiemThiSauCung D
    WHERE HOCVIEN.MAHV = D.MAHV
);

-- 3 --
WITH DiemThiLan3Duoi5 AS (
    SELECT MAHV, MAMH
    FROM KETQUATHI
    WHERE LANTHI = 3 AND DIEM < 5
);
UPDATE HOCVIEN
SET GHICHU = 'Cam thi'
WHERE MAHV IN (
    SELECT MAHV
    FROM DiemThiLan3Duoi5
);

-- 4 --
UPDATE HOCVIEN
SET XEPLOAI = 
    CASE
        WHEN DIEMTB >= 9 THEN 'XS'
        WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN 'G'
        WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN 'K'
        WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN 'TB'
        ELSE 'Y'
    END;

-- PHAN 3 --
-- 1 --
SELECT HV.MAHV, HV.HO, HV.TEN, HV.NGSINH, HV.MALOP
FROM HOCVIEN HV
INNER JOIN LOP L ON HV.MAHV = L.TRGLOP;

-- 2 --
SELECT HV.MAHV, HV.HO, HV.TEN, KT.LANTHI, KT.DIEM
FROM HOCVIEN HV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
INNER JOIN LOP L ON HV.MALOP = L.MALOP
INNER JOIN MONHOC MH ON KT.MAMH = MH.MAMH
WHERE L.TENLOP = 'K12' AND MH.TENMH = 'CTRR'
ORDER BY HV.HO, HV.TEN;

-- 3 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
WHERE KT.LANTHI = 1 AND KT.KQUA = 'Dat';

-- 4 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
INNER JOIN LOP L ON HV.MALOP = L.MALOP
INNER JOIN MONHOC MH ON KT.MAMH = MH.MAMH
WHERE L.TENLOP = 'K11' AND MH.TENMH = 'CTRR' AND KT.LANTHI = 1 AND KT.KQUA = 'Khong Dat';

-- 5 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN LOP L ON HV.MALOP = L.MALOP
INNER JOIN MONHOC MH ON HV.MAMH = MH.MAMH
LEFT JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV AND MH.MAMH = KT.MAMH
WHERE L.TENLOP LIKE 'K%' AND MH.TENMH = 'CTRR' AND (KT.KQUA IS NULL OR KT.KQUA = 'Khong Dat');

-- 6 --
SELECT DISTINCT MH.MAMH, MH.TENMH
FROM MONHOC MH
INNER JOIN GIANGDAY GD ON MH.MAMH = GD.MAMH
INNER JOIN GIAOVIEN GV ON GD.MAGV = GV.MAGV
WHERE GV.HOTEN = 'Tran Tam Thanh' AND GD.HOCKY = 1 AND GD.NAM = 2006;

-- 7 --
SELECT DISTINCT MH.MAMH, MH.TENMH
FROM MONHOC MH
INNER JOIN GIANGDAY GD ON MH.MAMH = GD.MAMH
INNER JOIN LOP L ON GD.MALOP = L.MALOP
WHERE L.TENLOP = 'K11' AND GD.HOCKY = 1 AND GD.NAM = 2006;

-- 8 --
SELECT HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN LOP L ON HV.MALOP = L.MALOP
INNER JOIN GIANGDAY GD ON L.MALOP = GD.MALOP
INNER JOIN GIAOVIEN GV ON GD.MAGV = GV.MAGV
INNER JOIN MONHOC MH ON GD.MAMH = MH.MAMH
WHERE GV.HOTEN = 'Nguyen To Lan' AND MH.TENMH = 'Co So Du Lieu' AND L.TRGLOP = HV.MAHV;

-- 9 --
SELECT MH.MAMH, MH.TENMH
FROM MONHOC MH
INNER JOIN DIEUKIEN DK ON MH.MAMH = DK.MAMH_TRUOC
WHERE DK.MAMH = (SELECT MAMH FROM MONHOC WHERE TENMH = 'Co So Du Lieu');

-- 10 --
SELECT MH.MAMH, MH.TENMH
FROM MONHOC MH
INNER JOIN DIEUKIEN DK ON MH.MAMH = DK.MAMH_TRUOC
WHERE DK.MAMH_TRUOC = (SELECT MAMH FROM MONHOC WHERE TENMH = 'Cau Truc Roi Rac');

-- 11 --
SELECT DISTINCT GV.MAGV, GV.HOTEN
FROM GIAOVIEN GV
INNER JOIN GIANGDAY GD ON GV.MAGV = GD.MAGV
INNER JOIN MONHOC MH ON GD.MAMH = MH.MAMH
INNER JOIN LOP L ON GD.MALOP = L.MALOP
WHERE MH.TENMH = 'CTRR' AND GD.HOCKY = 1 AND GD.NAM = 2006
  AND L.TENLOP IN ('K11', 'K12');

-- 12 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
INNER JOIN MONHOC MH ON KT.MAMH = MH.MAMH
WHERE MH.TENMH = 'CSDL' AND KT.LANTHI = 1 AND KT.KQUA = 'Khong Dat'
  AND HV.MAHV NOT IN (
    SELECT MAHV
    FROM KETQUATHI
    WHERE MAMH = MH.MAMH AND LANTHI > 1
  );

-- 13 --
SELECT GV.MAGV, GV.HOTEN
FROM GIAOVIEN GV
LEFT JOIN GIANGDAY GD ON GV.MAGV = GD.MAGV
WHERE GD.MAGV IS NULL;

-- 14 --
SELECT GV.MAGV, GV.HOTEN
FROM GIAOVIEN GV
INNER JOIN KHOA K ON GV.MAKHOA = K.MAKHOA
LEFT JOIN GIANGDAY GD ON GV.MAGV = GD.MAGV
WHERE GD.MAGV IS NULL AND GD.MAKHOA = K.MAKHOA;

-- 15 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN LOP L ON HV.MALOP = L.MALOP
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
INNER JOIN MONHOC MH ON KT.MAMH = MH.MAMH
WHERE L.TENLOP = 'K11' AND (
  (KT.LANTHI > 3 AND KT.KQUA = 'Khong Dat')
  OR (KT.LANTHI = 2 AND MH.TENMH = 'CTRR' AND KT.DIEM = 5)
);

-- 16 --
SELECT DISTINCT GV.HOTEN
FROM GIAOVIEN GV
INNER JOIN GIANGDAY GD ON GV.MAGV = GD.MAGV
INNER JOIN MONHOC MH ON GD.MAMH = MH.MAMH
WHERE MH.TENMH = 'CTRR'
GROUP BY GV.HOTEN, GD.HOCKY, GD.NAM
HAVING COUNT(DISTINCT GD.MALOP) >= 2;

-- 17 --
SELECT HV.MAHV, HV.HO, HV.TEN, KT.LANTHI, KT.DIEM
FROM HOCVIEN HV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
INNER JOIN MONHOC MH ON KT.MAMH = MH.MAMH
WHERE MH.TENMH = 'CSDL'
  AND (KT.MAMH, KT.MAHV, KT.LANTHI) IN (
    SELECT MAMH, MAHV, MAX(LANTHI)
    FROM KETQUATHI
    GROUP BY MAMH, MAHV
  );

-- 18 --
SELECT HV.MAHV, HV.HO, HV.TEN, MAX(KT.DIEM) AS DIEM
FROM HOCVIEN HV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
INNER JOIN MONHOC MH ON KT.MAMH = MH.MAMH
WHERE MH.TENMH = 'Co So Du Lieu'
GROUP BY HV.MAHV, HV.HO, HV.TEN;

-- 19 --
SELECT MAKHOA, TENKHOA
FROM KHOA
ORDER BY NGTLAP
LIMIT 1;

-- 20 --
SELECT COUNT(*) AS SoLuong
FROM GIAOVIEN
WHERE HOCHAM IN ('GS', 'PGS');

-- 21 --
SELECT K.MAKHOA, K.TENKHOA, 
       COUNT(CASE WHEN GV.HOCVI IN ('CN', 'KS', 'Ths', 'TS', 'PTS') THEN 1 ELSE NULL END) AS SoLuongGiaoVien
FROM GIAOVIEN GV
INNER JOIN KHOA K ON GV.MAKHOA = K.MAKHOA
GROUP BY K.MAKHOA, K.TENKHOA;

-- 22 --
SELECT MAMH, TENMH,
       SUM(CASE WHEN KQUA = 'Dat' THEN 1 ELSE 0 END) AS SoLuongDat,
       SUM(CASE WHEN KQUA = 'Khong Dat' THEN 1 ELSE 0 END) AS SoLuongKhongDat
FROM KETQUATHI KT
INNER JOIN MONHOC MH ON KT.MAMH = MH.MAMH
GROUP BY MAMH, TENMH;

-- 23 --
SELECT DISTINCT GV.MAGV, GV.HOTEN
FROM GIAOVIEN GV
INNER JOIN LOP L ON GV.MAGV = L.TRGLOP
INNER JOIN GIANGDAY GD ON GV.MAGV = GD.MAGV
WHERE GD.MALOP = L.MALOP;

-- 24 --
SELECT HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN LOP L ON HV.MAHV = L.TRGLOP
WHERE L.SISO = (
  SELECT MAX(SISO) FROM LOP
);

-- 25 --
SELECT HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN LOP L ON HV.MAHV = L.TRGLOP
WHERE L.MALOP IN (
  SELECT MALOP
  FROM LOP
  WHERE MALOP IN (
    SELECT MALOP
    FROM GIANGDAY GD
    WHERE GD.MAGV = L.TRGLOP
  )
  AND MALOP NOT IN (
    SELECT MALOP
    FROM KETQUATHI KT
    WHERE KQUA = 'Đạt'
    GROUP BY MALOP
    HAVING COUNT(*) >= 3
  )
);

-- 26 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
WHERE KT.DIEM >= 9
GROUP BY HV.MAHV, HV.HO, HV.TEN
HAVING COUNT(KT.MAMH) = (
  SELECT MAX(TongMonDat)
  FROM (
    SELECT MAHV, COUNT(MAMH) AS TongMonDat
    FROM KETQUATHI
    WHERE DIEM >= 9
    GROUP BY MAHV
  ) AS Temp
);

-- 27 --
SELECT L.MALOP, HV.MAHV, HV.HO, HV.TEN
FROM LOP L
INNER JOIN HOCVIEN HV ON L.TRGLOP = HV.MAHV
INNER JOIN KETQUATHI KT ON HV.MAHV = KT.MAHV
WHERE KT.DIEM >= 9
GROUP BY L.MALOP, HV.MAHV, HV.HO, HV.TEN
HAVING COUNT(KT.MAMH) = (
  SELECT MAX(TongMonDat)
  FROM (
    SELECT MALOP, MAHV, COUNT(MAMH) AS TongMonDat
    FROM KETQUATHI KT2
    WHERE DIEM >= 9
    GROUP BY MALOP, MAHV
  ) AS Temp
  WHERE Temp.MALOP = L.MALOP
);

-- 28 --
SELECT GD.HOCKY, GD.NAM, GD.MAGV, GV.HOTEN,
       COUNT(DISTINCT GD.MAMH) AS SoMonHoc,
       COUNT(DISTINCT GD.MALOP) AS SoLop
FROM GIANGDAY GD
INNER JOIN GIAOVIEN GV ON GD.MAGV = GV.MAGV
GROUP BY GD.HOCKY, GD.NAM, GD.MAGV, GV.HOTEN;

-- 29 --
SELECT GD.HOCKY, GD.NAM, GD.MAGV, GV.HOTEN
FROM GIANGDAY GD
INNER JOIN GIAOVIEN GV ON GD.MAGV = GV.MAGV
GROUP BY GD.HOCKY, GD.NAM, GD.MAGV, GV.HOTEN
HAVING COUNT(DISTINCT GD.MAMH) = (
  SELECT MAX(SoMonHoc)
  FROM (
    SELECT HOCKY, NAM, MAGV, COUNT(DISTINCT MAMH) AS SoMonHoc
    FROM GIANGDAY
    GROUP BY HOCKY, NAM, MAGV
  ) AS Temp
  WHERE Temp.HOCKY = GD.HOCKY AND Temp.NAM = GD.NAM
);

-- 30 --
SELECT MH.MAMH, MH.TENMH
FROM MONHOC MH
INNER JOIN KETQUATHI KT ON MH.MAMH = KT.MAMH
WHERE KT.LANTHI = 1 AND KT.KQUA = 'Khong Dat'
GROUP BY MH.MAMH, MH.TENMH
ORDER BY COUNT(KT.MAHV) DESC
LIMIT 1;

-- 31 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
WHERE HV.MAHV NOT IN (
  SELECT KT.MAHV
  FROM KETQUATHI KT
  WHERE KT.LANTHI = 1 AND KT.KQUA = 'Khong Dat'
);

-- 32 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
WHERE HV.MAHV NOT IN (
  SELECT KT.MAHV
  FROM KETQUATHI KT
  WHERE KT.LANTHI = (
    SELECT MAX(LANTHI)
    FROM KETQUATHI
    WHERE MAHV = HV.MAHV
  ) AND KT.KQUA = 'Khong Dat'
);

-- 33 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
WHERE HV.MAHV IN (
  SELECT MAHV
  FROM MONHOC MH
  WHERE NOT EXISTS (
    SELECT MAMH
    FROM MONHOC
    WHERE NOT EXISTS (
      SELECT KT.MAHV
      FROM KETQUATHI KT
      WHERE KT.MAMH = MH.MAMH AND KT.LANTHI = 1 AND KT.MAHV = HV.MAHV AND KT.KQUA = 'Khong Dat'
    )
  )
);

-- 34 --
SELECT HV.MAHV, HV.HO, HV.TEN
FROM HOCVIEN HV
WHERE HV.MAHV IN (
  SELECT MAHV
  FROM MONHOC MH
  WHERE NOT EXISTS (
    SELECT MAMH
    FROM MONHOC
    WHERE NOT EXISTS (
      SELECT KT.MAHV
      FROM KETQUATHI KT
      WHERE KT.MAMH = MH.MAMH AND KT.LANTHI = (
        SELECT MAX(LANTHI)
        FROM KETQUATHI
        WHERE MAMH = MH.MAMH AND MAHV = HV.MAHV
      ) AND KT.MAHV = HV.MAHV AND KT.KQUA = 'Khong Dat'
    )
  )
);

-- 35 --
SELECT KT1.MAHV, HV.HO, HV.TEN, KT1.MAMH, MH.TENMH, KT1.DIEM
FROM KETQUATHI KT1
INNER JOIN HOCVIEN HV ON KT1.MAHV = HV.MAHV
INNER JOIN MONHOC MH ON KT1.MAMH = MH.MAMH
WHERE KT1.LANTHI = (
  SELECT MAX(LANTHI)
  FROM KETQUATHI KT2
  WHERE KT1.MAHV = KT2.MAHV AND KT1.MAMH = KT2.MAMH
)
AND KT1.DIEM = (
  SELECT MAX(DIEM)
  FROM KETQUATHI KT3
  WHERE KT1.MAHV = KT3.MAHV AND KT1.MAMH = KT3.MAMH AND KT1.LANTHI = KT3.LANTHI
)
GROUP BY KT1.MAHV, HV.HO, HV.TEN, KT1.MAMH, MH.TENMH, KT1.DIEM;

